#!/bin/sh -ex

PREFIX=${PREFIX:-"$HOME/.local"}
SOURCE_DIR="$PREFIX/src"
PACKAGES="$PREFIX/var/packages"

# to be overridden by "overrides" 
CONFIG_OPTS=''
CFLAGS="-Wl,-rpath=$PREFIX/lib -I$PREFIX/include"
LDFLAGS="-L$PREFIX/lib -L$/usr/lib"
export CFLAGS LDFLAGS PREFIX


build() {
	# don't run configure if the Makefile already exists
	if [ -x configure ] && ([ ! -f Makefile ] || [ configure -nt Makefile ]); then
		./configure $CONFIG_OPTS
	fi
}

package() {
	make install $MAKE_OPTS
}

install() {
	src="$1"
	cd "$src" || {
		echo "$0: $src doesn't exist" 1>&2;
		# don't exit if "/var/packages/$pkg" doesn't exist
		return;
	}

	# source overrides for "{CONFIG,MAKE}_OPTS"
	overrides="$PACKAGES/$src/overrides"
	if [ -f "$overrides" ]; then
		. "$overrides"
	fi
	build
	package
}

# print packages in optimal order of compilation 
packages() {
	cd "$PACKAGES"
	for pkg in *; do
		if [ -f "$pkg/deps" ]; then
			# prepare input for tsort
			xargs printf "$pkg %s\n" < "$pkg/deps" 
		fi
	done | tsort - | tac
}

main() {
	cp -a "$PREFIX/etc/skel/." "$HOME"
	# compile & install executibles
	cd "$SOURCE_DIR"
	for src in $(packages); do
		(install "$src")
	done

	# crontab
	echo sourcing crontab 1>&2
	crontab "$HOME/.local/etc/crontab"
}

main
