#!/bin/sh -ex

PREFIX=${PREFIX:-"$HOME/.local"}
SOURCE_DIR="$PREFIX/src"
PACKAGES="$PREFIX/var/lib/packages"

# to be overridden by "overrides" 
CC=musl-gcc
CFLAGS="-Wl,-rpath=$PREFIX/lib -I$PREFIX/include -I."
LDFLAGS="-L$PREFIX/lib"
NPROC=$(nproc)

case "$(uname)" in
	Linux) CFLAGS="$CFLAGS -fPIC";;
	*)
esac

export CC CFLAGS LDFLAGS PREFIX

prebuild() {
	if [ -r autogen.sh ]; then
		./autogen.sh
	fi
}

build() {
	# don't run configure if the Makefile already exists
	if [ -x configure ]; then
		./configure "CC=$CC" "CFLAGS=$CFLAGS" "LDFLAGS=$LDFLAGS" "--prefix=$PREFIX" $CONFIG_OPTS
	fi
}

package() {
	make install -j "$NPROC" "CC=$CC" "CFLAGS=$CFLAGS" "LDFLAGS=$LDFLAGS" "PREFIX=$PREFIX" $MAKE_OPTS
}

install() {
	src="$1"
	cd "$src" || {
		echo "$0: $src doesn't exist" 1>&2;
		# don't exit if "/var/packages/$pkg" doesn't exist
		return;
	}

	# source overrides for "{CONFIG,MAKE}_OPTS"
	overrides="$PACKAGES/overrides/${src##*/}"
	if [ -f "$overrides" ]; then
		. "$overrides"
	fi
	prebuild
	build
	package
}

# print packages in optimal order of compilation 
packages() {
	cd "$PACKAGES"
	for pkg in *; do
		if [ -f "deps/$pkg" ]; then
			# prepare input for tsort
			xargs -r printf "$pkg %s\n" < "deps/$pkg" 
		fi
	done | tsort - | tac
}

main() {
	cp -af "$PREFIX/etc/skel/." "$HOME"
	# compile & install executibles
	if [ $# -gt 0 ]; then
		realpath "$@" | while read src; do
			(install "$src")
		done
	else
		cd "$PREFIX/src"
		for src in $(packages); do
			(install "$src")
		done
	fi

	# crontab
	echo sourcing crontab 1>&2
	crontab "$HOME/.local/etc/crontab"
}

main "$@"
