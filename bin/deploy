#!/bin/sh -ex

SOURCE_DIR="$HOME/.local/src"
PREFIX=${PREFIX:-"$HOME/.local"}
PACKAGES="$PREFIX/var/packages"

# to be overridden by "overrides" 
CONFIG_OPTS=''
MAKE_OPTS="PREFIX=$PREFIX CFLAGS+=-I$PREFIX/include CFLAGS+=-I$PREFIX/include/ncurses LDFLAGS+=-L$PREFIX/lib"

install() {
	src="$1"
	cd "$src" || {
		echo "$0: $src doesn't exist" 1>&2;
		return;
	}

	# source overrides for "{CONFIG,MAKE}_OPTS"
	overrides="$PACKAGES/$src/overrides"
	if [ -f "$overrides" ]; then
		. "$overrides"
	fi
	# don't run configure if the Makefile already exists
	if [ -x configure ] && ([ ! -f Makefile ] || [ configure -nt Makefile ]); then
		./configure $CONFIG_OPTS
	fi
	CFLAGS="-Wl,-rpath=$HOME/.local/lib -I$PREFIX/include -I$PREFIX/include/ncurses"
	LDFLAGS="-L$PREFIX/lib -L/usr/lib"
	make install $MAKE_OPTS
}

# print packages in optimal order of compilation 
packages() {
	cd "$PACKAGES"
	for pkg in *; do
		if [ -f "$pkg/deps" ]; then
			# prepare input for tsort
			xargs printf "$pkg %s\n" < "$pkg/deps" 
		fi
	done | tsort - | tac
}

main() {
	export CFLAGS LDFLAGS

	cp -a "$PREFIX/etc/skel/." "$HOME"
	# compile & install executibles
	cd "$SOURCE_DIR"
	for src in $(packages); do
		(install "$src")
	done

	# crontab
	echo sourcing crontab 1>&2
	crontab "$HOME/.local/etc/crontab"
}

main
